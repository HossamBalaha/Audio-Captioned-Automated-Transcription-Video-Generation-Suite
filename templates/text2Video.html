{% extends "base.html" %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-11">
      <!-- Header -->
      <div class="mb-5 text-center">
        <h1 class="display-4 fw-bold mb-3 fs-2-5rem">
          <i class="bi bi-film me-3 text-primary icon-2-5rem" aria-hidden="true"></i>Create Text to Video
        </h1>
        <p class="lead text-muted fs-1-125rem">
          <i class="bi bi-magic text-info me-2 icon-1-25rem" aria-hidden="true"></i>
          Transform your text into a professional video with synchronized audio and captions
        </p>
      </div>

      <!-- Main Form Card -->
      <div class="card border-0 shadow-lg">
        <div class="card-header bg-gradient-primary py-4 px-5">
          <h4 class="mb-0 text-white fs-1-5rem">
            <i class="bi bi-pencil-square me-3 text-warning icon-1-5rem" aria-hidden="true"></i>Video Configuration
          </h4>
        </div>
        <div class="card-body p-5">

          <!-- Info Alerts -->
          <div class="alert alert-info border-0 mb-4 shadow-sm p-4">
            <h6 class="mb-2 fs-1rem">
              <i class="bi bi-lightbulb-fill me-2 text-info icon-1-125rem" aria-hidden="true"></i>
              <strong>Pro Tip:</strong>
            </h6>
            <p class="mb-0 fs-0-9375rem">Add pauses by using triple dots (...) in your text. Line breaks also create pauses.</p>
          </div>

          <div class="alert alert-warning border-0 mb-5 shadow-sm p-4">
            <h6 class="mb-2 fs-1rem">
              <i class="bi bi-exclamation-triangle-fill me-2 text-warning icon-1-125rem" aria-hidden="true"></i>
              <strong>Note:</strong>
            </h6>
            <p class="mb-0 fs-0-9375rem">Punctuation marks will be automatically cleaned up during processing.</p>
          </div>

          <!-- Form -->
          <form id="ttsForm">
            <!-- Text Input Section -->
            <div class="mb-5">
              <h5 class="fw-bold mb-4 fs-1-25rem">
                <i class="bi bi-file-text-fill me-2 text-primary" aria-hidden="true"></i>Text Content
              </h5>
              <label for="text" class="form-label fw-semibold mb-3 fs-1rem">
                <i class="bi bi-pencil me-2 text-primary" aria-hidden="true"></i>Enter Your Text
              </label>
              <p class="text-muted mb-3 fs-0-9375rem">What would you like to convert to video? (Minimum 10 characters required)</p>
              <textarea
                  class="form-control"
                  style="line-height: 1.6; padding: var(--spacing-md);"
                  id="text"
                  name="text"
                  rows="8"
                  placeholder="Type or paste your text here... Minimum 10 characters required."
                  required
                  minlength="10"
                  maxlength="5000"
                  aria-label="Text content for video"
                  aria-describedby="charCount"
              ></textarea>
              <div class="char-count-wrapper mt-3">
                <small class="form-text text-muted fs-0-875rem">
                  <i class="bi bi-input-cursor-text text-muted me-1" aria-hidden="true"></i>
                  <span id="charCount">0 characters</span> entered
                </small>
              </div>
              <div class="char-count-bar mt-2">
                <div class="char-count-progress" style="width: 0%"></div>
              </div>
            </div>

            <hr class="my-5">

            <!-- Audio Settings Section -->
            <div class="mb-5">
              <h5 class="fw-bold mb-4 fs-1-25rem">
                <i class="bi bi-speaker-fill me-2 text-success" aria-hidden="true"></i>Audio Settings
              </h5>
              <p class="text-muted mb-4 fs-0-9375rem">
                <i class="bi bi-music-note me-2 text-success" aria-hidden="true"></i>
                Choose the language and voice for your video
              </p>

              <div class="row g-4">
                <div class="col-md-4">
                  <label for="language" class="form-label fw-semibold mb-3 fs-1rem">
                    <i class="bi bi-translate me-2 text-success" aria-hidden="true"></i>Language
                  </label>
                  <select class="form-select form-select-lg fs-1rem" id="language" name="language" required aria-label="Select audio language">
                    <option value="">Select a language...</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="voice" class="form-label fw-semibold mb-3 fs-1rem">
                    <i class="bi bi-mic-fill me-2 text-success" aria-hidden="true"></i>Voice
                  </label>
                  <select class="form-select form-select-lg fs-1rem" id="voice" name="voice" required aria-label="Select voice">
                    <option value="">Select a voice...</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="speechRate" class="form-label fw-semibold mb-3 fs-1rem">
                    <i class="bi bi-speedometer2 me-2 text-success" aria-hidden="true"></i>Speech Rate
                    <span id="speechRateValue" class="badge bg-success ms-2 px-3 py-2 fs-0-9375rem">1.0x</span>
                  </label>
                  <input type="range" class="form-range speech-rate-slider" id="speechRate" name="speechRate" min="0.5" max="2" step="0.025" value="1.0" aria-label="Adjust speech rate">
                  <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted fs-0-875rem"><i class="bi bi-dash-lg"></i> Slower</small>
                    <small class="text-muted fs-0-875rem">Normal</small>
                    <small class="text-muted fs-0-875rem">Faster <i class="bi bi-plus-lg"></i></small>
                  </div>
                </div>
              </div>
            </div>

            <hr class="my-5">

            <!-- Video Settings Section -->
            <div class="mb-5">
              <h5 class="fw-bold mb-4 fs-1-25rem">
                <i class="bi bi-camera-video-fill me-2 text-info" aria-hidden="true"></i>Video Settings
              </h5>
              <p class="text-muted mb-4 fs-0-9375rem">
                <i class="bi bi-sliders me-2 text-info" aria-hidden="true"></i>
                Choose the output quality and format
              </p>

              <div class="row g-4">
                <div class="col-md-6">
                  <label for="videoQuality" class="form-label fw-semibold mb-3 fs-1rem">
                    <i class="bi bi-badge-hd me-2 text-info" aria-hidden="true"></i>Video Quality
                  </label>
                  <select class="form-select form-select-lg fs-1rem" id="videoQuality" name="videoQuality" required aria-label="Select video quality">
                    <option value="">Select quality...</option>
                  </select>
                  <small class="form-text text-muted d-block mt-3 fs-0-875rem">
                    <i class="bi bi-info-circle me-1" aria-hidden="true"></i>Higher quality = larger file size
                  </small>
                </div>
                <div class="col-md-6">
                  <label for="videoType" class="form-label fw-semibold mb-3 fs-1rem">
                    <i class="bi bi-aspect-ratio me-2 text-info" aria-hidden="true"></i>Video Type
                  </label>
                  <select class="form-select form-select-lg fs-1rem" id="videoType" name="videoType" required aria-label="Select video type">
                    <option value="">Select type...</option>
                  </select>
                  <small class="form-text text-muted d-block mt-3 fs-0-875rem">
                    <i class="bi bi-info-circle me-1" aria-hidden="true"></i>Horizontal for widescreen, Vertical for mobile
                  </small>
                </div>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2 mb-4">
              <button type="submit" class="btn btn-primary btn-lg fw-bold py-4 shadow fs-1-25rem" aria-label="Submit video creation form">
                <i class="bi bi-play-circle-fill me-3 icon-1-5rem" aria-hidden="true"></i>Create Video Job
              </button>
            </div>
            <p class="text-center text-muted fs-0-9375rem">
              <i class="bi bi-clock-history text-muted me-2" aria-hidden="true"></i>
              This will queue your job. Processing time depends on text length and system load.
            </p>
          </form>

          <!-- Success Result -->
          <div id="result" class="mt-5 d-none">
            <div class="alert alert-success border-0 shadow-lg p-5">
              <div class="d-flex align-items-center mb-4">
                <i class="bi bi-check-circle-fill me-3 text-success icon-3rem" aria-hidden="true"></i>
                <h5 class="mb-0 fs-1-5rem">Job Created Successfully!</h5>
              </div>
              <p class="mb-4 fs-1-0625rem">
                <i class="bi bi-info-circle text-success me-2" aria-hidden="true"></i>
                Your video job has been queued and will start processing shortly.
              </p>
              <div class="card bg-light border-0 mb-4 p-4">
                <small class="text-muted mb-2 fs-0-875rem">
                  <i class="bi bi-tag-fill text-primary me-2" aria-hidden="true"></i>Job ID:
                </small>
                <p class="fw-bold font-monospace mb-0 fs-1-0625rem" id="jobId"></p>
              </div>
              <div class="d-grid gap-3">
                <a href="/jobs" class="btn btn-success btn-lg py-3 fs-1-0625rem">
                  <i class="bi bi-briefcase-fill me-2" aria-hidden="true"></i>View Your Jobs
                </a>
                <button id="createAnotherBtn" type="button" class="btn btn-outline-primary btn-lg py-3 fs-1-0625rem">
                  <i class="bi bi-plus-circle-fill me-2" aria-hidden="true"></i>Create Another Video
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Feature List -->
      <div class="row g-4 mt-5">
        <div class="col-md-4">
          <div class="card border-0 bg-light text-center shadow-sm">
            <div class="card-body py-5 px-4">
              <i class="bi bi-badge-cc-fill text-primary mb-3 icon-3rem" aria-hidden="true"></i>
              <h6 class="fw-bold mb-2 text-primary fs-1-0625rem">Auto Captions</h6>
              <p class="text-muted mb-0 fs-0-9375rem">Synchronized word-by-word captions</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card border-0 bg-light text-center shadow-sm">
            <div class="card-body py-5 px-4">
              <i class="bi bi-globe-americas text-success mb-3 icon-3rem" aria-hidden="true"></i>
              <h6 class="fw-bold mb-2 text-success fs-1-0625rem">Multi-Language</h6>
              <p class="text-muted mb-0 fs-0-9375rem">50+ languages supported</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card border-0 bg-light text-center shadow-sm">
            <div class="card-body py-5 px-4">
              <i class="bi bi-lightning-charge-fill text-info mb-3 icon-3rem" aria-hidden="true"></i>
              <h6 class="fw-bold mb-2 text-info fs-1-0625rem">Fast Processing</h6>
              <p class="text-muted mb-0 fs-0-9375rem">Queue-based background processing</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  $(document).ready(function () {
    let allVoices = null;
    let allLanguages = null;
    let allVideoTypes = null;
    let allVideoQualities = null;

    function disableForm(disabled) {
      $("#ttsForm :input").prop("disabled", disabled).toggleClass("disabled", disabled);
      {
        // console.log("Form disabled:", disabled);
      }
    }

    function checkLoadedData() {
      const voicesLoaded = $("#voice option").length > 0;
      const languagesLoaded = $("#language option").length > 0;
      const videoTypesLoaded = $("#videoType option").length > 0;
      const videoQualitiesLoaded = $("#videoQuality option").length > 0;
      return voicesLoaded && languagesLoaded && videoTypesLoaded && videoQualitiesLoaded;
    }

    disableForm(true);

    // Update speech rate value display.
    $("#speechRate").on("input change", function () {
      $("#speechRateValue").text(`${$(this).val()}x`);
    });
    $("#speechRateValue").text(`${$("#speechRate").val()}x`);


    $.get("/api/v1/voices?type=dict", function (data) {
      const voiceSelect = $("#voice");
      Object.keys(data["voices"]).forEach(voiceList => {
        // Add separator for each voice list.
        voiceSelect.append(`<optgroup label="${voiceList}"></optgroup>`);
        data["voices"][voiceList].forEach(voice => {
          // Add each voice as an option.
          let voiceName = voice;
          voiceName = voiceName.replace(/_/g, " ");
          voiceName = voiceName.charAt(3).toUpperCase() + voiceName.slice(4);
          voiceSelect.find(`optgroup[label="${voiceList}"]`).append(`<option value="${voice}">${voiceName}</option>`);
        });
      });
      allVoices = data["voices"];
      if (checkLoadedData()) {
        disableForm(false);
      }
    });

    $.get("/api/v1/languages", function (data) {
      const languageSelect = $("#language");
      // Loop on the dictionary keys.
      Object.keys(data["languages"]).forEach(lang => {
        languageSelect.append(`<option value="${lang}">${data["languages"][lang]}</option>`);
      });
      allLanguages = data["languages"];
      // Check if the voices and languages are loaded.
      if (checkLoadedData()) {
        disableForm(false);
      }
    });

    $.get("/api/v1/videoTypes", function (data) {
      const videoTypeSelect = $("#videoType");
      // Loop on the dictionary keys.
      Object.keys(data["videoTypes"]).forEach(type => {
        videoTypeSelect.append(`<option value="${data["videoTypes"][type]}">${data["videoTypes"][type]}</option>`);
      });
      allVideoTypes = data["videoTypes"];
      // Check if the voices and languages are loaded.
      if (checkLoadedData()) {
        disableForm(false);
      }
    });

    $.get("/api/v1/videoQualities", function (data) {
      const videoQualitySelect = $("#videoQuality");
      // Loop on the dictionary keys.
      Object.keys(data["videoQualities"]).forEach(quality => {
        videoQualitySelect.append(`<option value="${data["videoQualities"][quality][0]}">
          ${data["videoQualities"][quality][0]}
        </option>`);
      });
      allVideoQualities = data["videoQualities"];
      // Check if the voices and languages are loaded.
      if (checkLoadedData()) {
        disableForm(false);
      }
    });


    // Handle form submission.
    $("#ttsForm").submit(function (e) {
      e.preventDefault();

      // Disable the form to prevent multiple submissions.
      disableForm(true);
      // Validate the form.
      if (!$("#text").val().trim()) {
        // SweetAlert for empty text.
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Text field cannot be empty.",
          confirmButtonText: "OK"
        });
        disableForm(false);
        return;
      }
      if (!$("#language").val()) {
        // SweetAlert for empty language.
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Please select a language.",
          confirmButtonText: "OK"
        });
        disableForm(false);
        return;
      }
      if (!$("#voice").val()) {
        // SweetAlert for empty voice.
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Please select a voice.",
          confirmButtonText: "OK"
        });
        disableForm(false);
        return;
      }
      if (!$("#speechRate").val() || isNaN($("#speechRate").val()) || $("#speechRate").val() < 0.5 || $("#speechRate").val() > 2) {
        // SweetAlert for invalid speech rate.
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Please select a valid speech rate between 0.5x and 2x.",
          confirmButtonText: "OK"
        });
        disableForm(false);
        return;
      }

      const data = {
        text: $("#text").val(),
        language: $("#language").val(),
        voice: $("#voice").val(),
        speechRate: parseFloat($("#speechRate").val()),
        videoType: $("#videoType").val(),
        videoQuality: $("#videoQuality").val(),
      };

      $("#result").addClass("d-none");

      $.ajax({
        url: "/api/v1/jobs",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(data),
        success: function (response) {
          $("#jobId").text(response.jobId);
          $("#result").removeClass("d-none");
          $("#ttsForm")[0].reset();
          Swal.fire({
            icon: "success",
            title: "Job Created",
            text: `Job ID: ${response.jobId}`,
            confirmButtonText: "OK"
          });
          disableForm(false);
          // console.log("Job created successfully:", response);
        },
        error: function (xhr) {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: xhr.responseJSON ? xhr.responseJSON.error : "An error occurred while creating the job.",
            confirmButtonText: "OK"
          });
          console.error("Error creating job:", xhr);
        }
      });
    });

    // Create Another Video button handler: hide result and reset form
    $(document).on('click', '#createAnotherBtn', function () {
      $('#result').addClass('d-none');
      $('#ttsForm')[0].reset();
      disableForm(false);
      $('#text').focus();
      // Reset character counter and progress if present
      $('#charCount').text('0 characters');
      $('.char-count-progress').css('width', '0%');
    });
  });
</script>
{% endblock %}
