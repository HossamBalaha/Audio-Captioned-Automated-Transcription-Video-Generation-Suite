{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Jobs Management</h2>
  <button id="refreshBtn" class="btn btn-outline-primary">
    <i class="bi bi-arrow-clockwise"></i> Refresh
  </button>
</div>

<div class="card" id="jobsCard">
  <div class="card-header">
    <h5 class="card-title mb-0">Active Jobs</h5>
  </div>
  <div class="card-body">
    <div id="jobsContainer">
      <div class="text-center py-5">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="mt-3 text-end">
  <button id="deleteAllBtn" class="btn btn-danger">
    <i class="bi bi-trash"></i> Delete All Jobs
  </button>
</div>
{% endblock %}

{% block scripts %}
<script>
  function loadJobs() {
    function capitalizeFirstLetter(str) {
      if (str.length === 0) {
        return ""; // Handle empty strings
      }
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function escapeHtml(unsafe) {
      return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;"); // or &#x27;
    }

    $("#jobsContainer").html('<div class="text-center py-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>');

    $.get("/api/v1/jobs", function (data) {
      let html = '';
      if (data.jobs.length === 0) {
        html = '<div class="text-center py-5"><p class="text-muted">No jobs found</p></div>';
      } else {
        html = '<div class="row">';
        data.jobs.forEach(job => {
          let isCompleted = job["isCompleted"];

          html += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">${job.text.substring(0, 16)}${job.text.length >= 16 ? "..." : ""}</h6>
                            <hr class="mb-2">
                            <p class="card-text">
                                <small class="text-muted">
                                    Status: <span class="badge bg-${getStatusClass(job.status)}">${capitalizeFirstLetter(job.status)}</span><br>
                                    Created: ${new Date(job.createdAt).toLocaleString()}
                                </small>
                            </p>
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-sm btn-outline-primary view-btn" data-id="${job.jobId}" data-text="${escapeHtml(job.text)}">
                                    <i class="bi bi-eye"></i> View
                                </button>
                                ${job.status === 'completed' ?
              `<a href="/api/v1/jobs/${job.jobId}/result" class="btn btn-sm btn-outline-success">
                                    <i class="bi bi-download"></i> Download
                                </a>` : ''}
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${job.jobId}">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
        });
        html += '</div>';
      }

      $("#jobsContainer").html(html);
    }).fail(function (e) {
      $("#jobsContainer").html('<div class="alert alert-danger">Failed to load jobs</div>');
      console.error("Error loading jobs");
      console.error(e);
    });
  }

  function getStatusClass(status) {
    switch (status) {
      case "completed":
        return "success";
      case "queued":
        return "warning";
      case "processing":
        return "info";
      default:
        return "secondary";
    }
  }

  $(document).ready(function () {
    loadJobs();

    function escapeHtml(unsafe) {
      return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
    }

    $("#refreshBtn").click(loadJobs);

    $(document).on("click", ".view-btn", function () {
      const jobId = $(this).data("id");
      const jobText = $(this).data("text");
      // Replace the new line characters with <br> for HTML display.
      // Escape HTML to prevent XSS attacks.
      const escapedText = escapeHtml(jobText).replace(/\n/g, "<br>");
      // Create a bootstrap modal to display job details.
      const modalHtml = `
        <div class="modal fade" id="jobDetailsModal" tabindex="-1"
          data-bs-keyboard="false" tabindex="-1"
          aria-labelledby="jobDetailsModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="jobDetailsModalLabel">Job Details - ${jobId}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p><strong>Job ID:</strong> ${jobId}</p>
                <hr>
                <p><strong>Text:</strong></p>
                <div class="text-start">${escapedText}<div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>`;
      $("#jobsCard").append(modalHtml);
      $("#jobDetailsModal").modal("show");
      $("#jobDetailsModal").on("hidden.bs.modal", function () {
        $(this).remove(); // Remove the modal from the DOM after closing it.
      });
    });

    $(document).on("click", ".delete-btn", function () {
      const jobId = $(this).data('id');
      Swal.fire({
        title: "Delete Job",
        text: "Are you sure you want to delete this job? This action cannot be undone.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, delete it",
        cancelButtonText: "No, cancel"
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            url: `/api/v1/jobs/${jobId}`,
            method: "DELETE",
            success: function () {
              loadJobs();
              Swal.fire("Deleted!", "The job has been deleted.", "success");
            },
            error: function () {
              Swal.fire("Error!", "Failed to delete the job.", "error");
            }
          });
        }
      });
    });

    $("#deleteAllBtn").click(function () {
      Swal.fire({
        title: "Delete All Jobs",
        text: "This action cannot be undone. Are you sure you want to delete all jobs?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, delete all",
        cancelButtonText: "No, cancel"
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            url: "/api/v1/jobs",
            method: "DELETE",
            success: function () {
              loadJobs();
              Swal.fire("Deleted!", "All jobs have been deleted.", "success");
            },
            error: function () {
              Swal.fire("Error!", "Failed to delete jobs.", "error");
            }
          });
        }
      });
    });
  });
</script>
{% endblock %}
