{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-5">
  <!-- Page Header -->
  <div class="mb-5 text-center">
    <h1 class="display-4 fw-bold mb-3 fs-2-5rem">
      <i class="bi bi-briefcase-fill me-3 text-success icon-2-5rem" aria-hidden="true"></i>Jobs
      Management
    </h1>
    <p class="lead text-muted fs-1-125rem">
      <i class="bi bi-gear-fill text-primary me-2 icon-1-25rem" aria-hidden="true"></i>
      View, manage, and download your video processing jobs
    </p>
  </div>

  <!-- Action Bar -->
  <div class="row mb-5 g-3 align-items-end">
    <div class="col-auto">
      <label class="form-label fw-semibold mb-2 d-block fs-1rem">
        <i class="bi bi-funnel-fill text-primary me-2" aria-hidden="true"></i>Filter by Status
      </label>
      <select id="statusFilter"
              class="form-select form-select shadow-sm fs-1rem"
              aria-label="Filter jobs by status"
              style="min-width: 11.25rem;">
        <option value="all">All Jobs</option>
        <option value="queued">Queued</option>
        <option value="processing">Processing</option>
        <option value="completed">Completed</option>
        <option value="failed">Failed</option>
        <option value="canceled">Canceled</option>
      </select>
    </div>
    <div class="col-auto">
      <button id="refreshBtn" class="btn btn-outline-primary btn px-4 shadow-sm fs-1rem"
              title="Refresh job list">
        <i class="bi bi-arrow-clockwise me-2" aria-hidden="true"></i> Refresh
      </button>
    </div>
    <div class="col-auto ms-auto">
      <button id="triggerRemaining" class="btn btn-outline-success btn px-4 shadow-sm fs-1rem"
              title="Process remaining queued jobs">
        <i class="bi bi-play-fill me-2" aria-hidden="true"></i> Trigger Jobs
      </button>
    </div>
    <div class="col-auto">
      <button id="deleteAllBtn" class="btn btn-outline-danger btn px-4 shadow-sm fs-1rem"
              title="Delete all jobs permanently">
        <i class="bi bi-trash me-2" aria-hidden="true"></i> Delete All
      </button>
    </div>
  </div>

  <!-- Main Jobs Card -->
  <div class="card border-0 shadow-lg" id="jobsCard">
    <div class="card-header bg-gradient-primary py-4 px-4">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <h5 class="mb-0 text-white fw-bold fs-1-25rem">
          <i class="bi bi-list-check me-3 text-warning icon-1-5rem" aria-hidden="true"></i>Active Jobs
        </h5>
        <div class="d-flex align-items-center gap-2">
          <span id="ffmpegBadge" class="badge bg-light text-dark fw-semibold px-3 py-2 fs-0-9375rem">
            <i class="bi bi-hourglass-split me-2 text-primary" aria-hidden="true"></i>FFmpeg: Checking...
          </span>
        </div>
      </div>
    </div>

    <!-- Jobs List -->
    <div class="card-body p-4">
      <div id="jobsContainer">
        <div class="text-center py-5">
          <div class="spinner-border text-primary spinner-lg" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted fs-1-0625rem">Loading jobs...</p>
        </div>
      </div>
    </div>

    <!-- Pagination Footer -->
    <div class="card-footer bg-light border-top py-4 px-4">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div id="paginationControls" class="d-flex align-items-center gap-3">
          <button id="prevPageBtn" class="btn btn-outline-secondary px-4 py-2 fs-0-9375rem"
                  title="Previous page">
            <i class="bi bi-chevron-left me-1" aria-hidden="true"></i> Prev
          </button>
          <span id="pageInfo" class="badge bg-secondary fw-semibold px-4 py-2 fs-0-9375rem"
          >Page 1 of 1</span>
          <button id="nextPageBtn" class="btn btn-outline-secondary px-4 py-2 fs-0-9375rem"
                  title="Next page">
            Next <i class="bi bi-chevron-right ms-1" aria-hidden="true"></i>
          </button>
        </div>
        <div class="d-flex align-items-center gap-3">
          <label for="pageSizeSelect" class="form-label mb-0 fw-semibold fs-0-9375rem">Per
            page:</label>
          <select id="pageSizeSelect" class="form-select fs-0-9375rem" style="width: 6.25rem;">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Pagination state variables.
  let currentPage = 1;
  let currentPageSize = 20;
  let currentFilter = "all";
  let totalJobs = 0;

  function GetStatusClass(status) {
    // Map status to bootstrap badge classes.
    switch (status) {
      case "completed":
        return "success";
      case "queued":
        return "warning";
      case "processing":
        return "info";
      case "failed":
        return "danger";
      case "canceled":
        return "secondary";
      default:
        return "secondary";
    }
  }

  function CapitalizeFirstLetter(str) {
    // Capitalize the first letter of a string.
    if (str.length === 0) {
      return "";
    }
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  function EscapeHtml(unsafe) {
    // Escape HTML special characters to avoid XSS issues.
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
  }

  function UpdatePaginationControls() {
    // Update pagination labels and button disabled state.
    const totalPages = Math.max(1, Math.ceil(totalJobs / currentPageSize));
    $("#pageInfo").text(`Page ${currentPage} of ${totalPages}`);
    $("#prevPageBtn").prop("disabled", (currentPage <= 1));
    $("#nextPageBtn").prop("disabled", (currentPage >= totalPages));
  }

  function LoadJobs() {
    // Display loading spinner while fetching jobs.
    $("#jobsContainer").html('<div class="text-center py-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>');

    // Fetch jobs with pagination parameters.
    $.get(`/api/v1/jobs?page=${currentPage}&pageSize=${currentPageSize}`, function (data) {
      totalJobs = data.total || (data.jobs ? data.jobs.length : 0);
      let jobs = data.jobs || [];
      // Apply client-side filter for status, if not "all".
      if (currentFilter !== "all") {
        jobs = jobs.filter(j => (j.status === currentFilter));
      }

      let html = "";
      if (jobs.length === 0) {
        html = '<div class="text-center py-5"><i class="bi bi-inbox text-muted mb-3 d-block icon-3rem" aria-hidden="true"></i><p class="text-muted fs-1-0625rem">No text to video jobs found.</p></div>';
      } else {
        html = '<div class="row g-4">';
        jobs.forEach(job => {
          const isCompleted = job.isCompleted;
          const statusClass = GetStatusClass(job.status);
          const jobTextShort = EscapeHtml(job.text).substring(0, 20);
          const jobTextEllipsis = (job.text.length >= 20) ? "..." : "";
          html += `
            <div class="col-md-6 col-lg-4 mb-3">
              <div class="card shadow-sm h-100">
                <div class="card-body p-4">
                  <h6 class="card-title fw-bold mb-3 fs-1-125rem" title="${EscapeHtml(job.text)}">${jobTextShort}${jobTextEllipsis}</h6>
                  <hr class="mb-3">
                  <div class="mb-3 fs-0-9375rem">
                    <p class="mb-2"><i class="bi bi-circle-fill me-2 text-${statusClass} icon-0-5rem" aria-hidden="true"></i><strong>Status:</strong> <span class="badge bg-${statusClass} px-3 py-1 fs-0-875rem">${CapitalizeFirstLetter(job.status)}</span></p>
                    <p class="mb-2"><i class="bi bi-arrow-repeat me-2 text-muted" aria-hidden="true"></i><strong>Retries:</strong> ${typeof job.retries !== "undefined" ? job.retries : 0}</p>
                    <p class="mb-0"><i class="bi bi-calendar-event me-2 text-muted" aria-hidden="true"></i><strong>Created:</strong> ${new Date(job.createdAt).toLocaleString()}</p>
                  </div>
                  <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary viewBtn py-2 fs-0-9375rem" data-id="${job.jobId}" data-text="${EscapeHtml(job.text)}">
                      <i class="bi bi-eye-fill me-2" aria-hidden="true"></i> View Details
                    </button>
                    ${isCompleted ?
              `<a href="/api/v1/jobs/${job.jobId}/result" class="btn btn-success py-2 fs-0-9375rem">
                        <i class="bi bi-download me-2" aria-hidden="true"></i> Download
                      </a>` :
              ""}
                    <div class="btn-group" role="group">
                      <button class="btn btn-outline-warning retryBtn py-2 fs-0-9375rem" data-id="${job.jobId}" ${job.status === "completed" ? "disabled" : ""}>
                        <i class="bi bi-arrow-repeat me-1" aria-hidden="true"></i> Retry
                      </button>
                      <button class="btn btn-outline-secondary cancelBtn py-2 fs-0-9375rem" data-id="${job.jobId}" ${job.status === "completed" ? "disabled" : ""}>
                        <i class="bi bi-x-circle me-1" aria-hidden="true"></i> Cancel
                      </button>
                    </div>
                    <button class="btn btn-outline-danger deleteBtn py-2 fs-0-9375rem" data-id="${job.jobId}">
                      <i class="bi bi-trash me-2" aria-hidden="true"></i> Delete
                    </button>
                  </div>
                </div>
              </div>
            </div>`;
        });
        html += '</div>';
      }

      $("#jobsContainer").html(html);
      UpdatePaginationControls();
    }).fail(function (e) {
      $("#jobsContainer").html('<div class="alert alert-danger">Failed to load jobs.</div>');
      console.error("Error loading jobs.");
      console.error(e);
    });
  }

  function UpdateFfmpegBadge() {
    // Poll status endpoint and update ffmpeg availability badge.
    $.get("/api/v1/status", function (data) {
      const badge = $("#ffmpegBadge");
      if (data && data.ffmpegAvailable) {
        badge.removeClass("bg-secondary bg-danger").addClass("bg-success");
        badge.html(`<i class='bi bi-check-circle me-1'></i> FFmpeg: Ready`);
      } else {
        badge.removeClass("bg-secondary bg-success").addClass("bg-danger");
        badge.html(`<i class='bi bi-x-circle me-1'></i> FFmpeg: Not Found`);
      }
    }).fail(function () {
      const badge = $("#ffmpegBadge");
      badge.removeClass("bg-success bg-secondary").addClass("bg-danger");
      badge.html(`<i class='bi bi-exclamation-circle me-1'></i> FFmpeg: Error`);
    });
  }

  $(document).ready(function () {
    // Initial load with defaults.
    LoadJobs();

    // Refresh button reloads the current page.
    $("#refreshBtn").click(function () {
      LoadJobs();
    });

    // Filter change updates currentFilter and reloads jobs.
    $("#statusFilter").change(function () {
      currentFilter = $(this).val();
      LoadJobs();
    });

    // Page size change resets to first page and reloads.
    $("#pageSizeSelect").change(function () {
      currentPageSize = parseInt($(this).val(), 10);
      currentPage = 1;
      LoadJobs();
    });

    // Prev and Next page buttons.
    $("#prevPageBtn").click(function () {
      if (currentPage > 1) {
        currentPage -= 1;
        LoadJobs();
      }
    });
    $("#nextPageBtn").click(function () {
      const totalPages = Math.max(1, Math.ceil(totalJobs / currentPageSize));
      if (currentPage < totalPages) {
        currentPage += 1;
        LoadJobs();
      }
    });

    // View details handler with cached jQuery element to avoid duplicate selector warnings.
    $(document).on("click", ".viewBtn", function () {
      const jobId = $(this).data("id");
      const jobText = $(this).data("text");
      const escapedText = EscapeHtml(jobText).replace(/\n/g, "<br>");

      // Remove any existing modal first
      $("#jobDetailsModal").remove();

      const modalHtml = `
        <div class="modal fade" id="jobDetailsModal" tabindex="-1" aria-labelledby="jobDetailsModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="jobDetailsModalLabel">
                  <i class="bi bi-info-circle-fill"></i>Job Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="row g-3 mb-4">
                  <div class="col-md-12">
                    <div class="card bg-light border-0">
                      <div class="card-body">
                        <p class="text-muted mb-2 fs-0-875rem">
                          <i class="bi bi-tag-fill text-primary me-2"></i>Job ID
                        </p>
                        <p class="fw-bold font-monospace mb-0 fs-1rem">${jobId}</p>
                      </div>
                    </div>
                  </div>
                </div>
                <hr class="my-3">
                <div class="mb-3">
                  <h6 class="fw-bold mb-3 fs-1-0625rem">
                    <i class="bi bi-file-text text-primary me-2"></i>Job Text Content:
                  </h6>
                  <div class="card bg-light border-0">
                    <div class="card-body">
                      <p class="mb-0 fs-0-9375rem" style="white-space: pre-wrap; word-wrap: break-word; line-height: 1.6;">${escapedText}</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
                  <i class="bi bi-x-circle me-2"></i>Close
                </button>
              </div>
            </div>
          </div>
        </div>`;

      $("body").append(modalHtml);

      // Use Bootstrap 5 Modal API
      const modalElement = document.getElementById("jobDetailsModal");
      const modal = new bootstrap.Modal(modalElement);
      modal.show();

      // Ensure the backdrop and modal have the correct z-index after Bootstrap inserts the backdrop
      modalElement.addEventListener('shown.bs.modal', function () {
        // set all backdrops z-index just in case there are multiple
        document.querySelectorAll('.modal-backdrop').forEach(function (el) {
          el.style.zIndex = '999998';
        });
        modalElement.style.zIndex = '999999';
      });

      // Clean up when modal is hidden
      modalElement.addEventListener('hidden.bs.modal', function () {
        modal.dispose();
        $(this).remove();
      });
    });

    // Cancel job handler.
    $(document).on("click", ".cancelBtn", function () {
      const jobId = $(this).data("id");
      Swal.fire({
        title: "Cancel Job",
        text: "Do you want to cancel this job? If processing, cancellation will be attempted at the next safe point.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, cancel",
        cancelButtonText: "No, keep"
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            url: `/api/v1/jobs/${jobId}/cancel`,
            method: "DELETE",
            success: function () {
              LoadJobs();
              Swal.fire("Canceled!", "The job was canceled or cancellation was requested.", "success");
            },
            error: function () {
              Swal.fire("Error!", "Failed to cancel the job.", "error");
            }
          });
        }
      });
    });

    // Retry job handler.
    $(document).on("click", ".retryBtn", function () {
      const jobId = $(this).data("id");
      Swal.fire({
        title: "Retry Job",
        text: "Do you want to retry this job? Completed jobs cannot be retried.",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "Yes, retry",
        cancelButtonText: "No, cancel"
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            url: `/api/v1/jobs/${jobId}/retry`,
            method: "POST",
            success: function () {
              LoadJobs();
              Swal.fire("Re-queued!", "The job has been re-queued for processing.", "success");
            },
            error: function (xhr) {
              const msg = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : "Failed to retry the job.";
              Swal.fire("Error!", msg, "error");
            }
          });
        }
      });
    });

    // Delete job handler.
    $(document).on("click", ".deleteBtn", function () {
      const jobId = $(this).data("id");
      Swal.fire({
        title: "Delete Job",
        text: "Are you sure you want to delete this job? This action cannot be undone.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, delete",
        cancelButtonText: "No, cancel"
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            url: `/api/v1/jobs/${jobId}`,
            method: "DELETE",
            success: function () {
              LoadJobs();
              Swal.fire("Deleted!", "The job has been deleted.", "success");
            },
            error: function () {
              Swal.fire("Error!", "Failed to delete the job.", "error");
            }
          });
        }
      });
    });

    // Trigger remaining queued jobs.
    $("#triggerRemaining").click(function () {
      Swal.fire({
        title: "Trigger Remaining Jobs",
        text: "This will trigger all remaining queued jobs. Proceed?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, trigger",
        cancelButtonText: "No, cancel"
      }).then((result) => {
        if (result.isConfirmed) {
          $.post("/api/v1/jobs/triggerRemaining", function (response) {
            LoadJobs();
            const responseMessage = response.message || "All remaining jobs have been triggered.";
            Swal.fire("Triggered!", responseMessage, "success");
          }).fail(function () {
            Swal.fire("Error!", "Failed to trigger remaining jobs.", "error");
          });
        }
      });
    });

    // Delete all jobs.
    $("#deleteAllBtn").click(function () {
      Swal.fire({
        title: "Delete All Jobs",
        text: "This action cannot be undone. Delete all jobs?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, delete all",
        cancelButtonText: "No, cancel"
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            url: "/api/v1/jobs/all",
            method: "DELETE",
            success: function () {
              LoadJobs();
              Swal.fire("Deleted!", "All jobs have been deleted.", "success");
            },
            error: function () {
              Swal.fire("Error!", "Failed to delete jobs.", "error");
            }
          });
        }
      });
    });

    UpdateFfmpegBadge();
    setInterval(UpdateFfmpegBadge, 5000);
  });
</script>
{% endblock %}
