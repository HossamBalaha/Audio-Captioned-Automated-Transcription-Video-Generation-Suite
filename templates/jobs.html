{% extends "base.html" %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Jobs Management</h2>
    <button id="refreshBtn" class="btn btn-outline-primary">
      <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
  </div>

  <div class="card">
    <div class="card-header">
      <h5 class="card-title mb-0">Active Jobs</h5>
    </div>
    <div class="card-body">
      <div id="jobsContainer">
        <div class="text-center py-5">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-3">
    <button id="deleteAllBtn" class="btn btn-danger">
      <i class="bi bi-trash"></i> Delete All Jobs
    </button>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    function loadJobs() {
      $("#jobsContainer").html('<div class="text-center py-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>');

      $.get("/api/v1/jobs", function (data) {
        let html = '';
        if (data.jobs.length === 0) {
          html = '<div class="text-center py-5"><p class="text-muted">No jobs found</p></div>';
        } else {
          html = '<div class="row">';
          data.jobs.forEach(job => {
            let isCompleted = job["isCompleted"];
            html += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">${job.jobId.substring(0, 8)}...</h6>
                            <p class="card-text">
                                <small class="text-muted">
                                    Status: <span class="badge bg-${getStatusClass(job.status)}">${job.status}</span><br>
                                    Created: ${new Date(job.createdAt).toLocaleString()}
                                </small>
                            </p>
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-sm btn-outline-primary view-btn" data-id="${job.jobId}">
                                    <i class="bi bi-eye"></i> View
                                </button>
                                ${job.status === 'completed' ?
                                `<a href="/api/v1/jobs/${job.jobId}/result" class="btn btn-sm btn-outline-success">
                                    <i class="bi bi-download"></i> Download
                                </a>` : ''}
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${job.jobId}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
          });
          html += '</div>';
        }

        $("#jobsContainer").html(html);
      }).fail(function (e) {
        $("#jobsContainer").html('<div class="alert alert-danger">Failed to load jobs</div>');
        console.error("Error loading jobs");
        console.error(e);
      });
    }

    function getStatusClass(status) {
      switch (status) {
        case 'completed':
          return 'success';
        case 'queued':
          return 'warning';
        case 'processing':
          return 'info';
        default:
          return 'secondary';
      }
    }

    $(document).ready(function () {
      loadJobs();

      $("#refreshBtn").click(loadJobs);

      $(document).on('click', '.view-btn', function () {
        const jobId = $(this).data('id');
        window.location.href = `/job/${jobId}`;
      });

      $(document).on('click', '.delete-btn', function () {
        const jobId = $(this).data('id');
        if (confirm('Are you sure you want to delete this job?')) {
          $.ajax({
            url: `/api/proxy/jobs/${jobId}`,
            method: 'DELETE',
            success: function () {
              loadJobs();
            }
          });
        }
      });

      $("#deleteAllBtn").click(function () {
        if (confirm('Are you sure you want to delete ALL jobs?')) {
          $.ajax({
            url: '/api/proxy/jobs',
            method: 'DELETE',
            success: function () {
              loadJobs();
            }
          });
        }
      });
    });
  </script>
{% endblock %}
